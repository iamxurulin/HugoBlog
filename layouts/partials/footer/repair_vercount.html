<script>
    (function() {
        let scriptElement = null;
        
        function initVercount() {
            console.log('ğŸ”µ initVercount å¼€å§‹æ‰§è¡Œ');
            
            // 1. æ£€æµ‹æ˜¯å¦åœ¨è¯¦æƒ…é¡µ
            const container = document.querySelector('.article-view');
            
            // å¦‚æœåœ¨é¦–é¡µ/åˆ—è¡¨é¡µ,éšè—æ‰€æœ‰å®¹å™¨å¹¶é€€å‡º
            if (!container || document.querySelector('.article-list')) {
                console.log('âŒ ä¸åœ¨è¯¦æƒ…é¡µ,éšè—å®¹å™¨');
                document.querySelectorAll('.article-view').forEach(el => {
                    el.style.display = 'none';
                });
                return; 
            }

            console.log('âœ… åœ¨è¯¦æƒ…é¡µ,å¼€å§‹å¤„ç†');
            
            // 2. æ˜¾ç¤ºå®¹å™¨
            container.style.display = 'flex';

            // 3. è·å–å…ƒç´ 
            const pvContainer = container.querySelector('.temp-pv-container');
            const pvValue = container.querySelector('.temp-pv-value');
            
            if (!pvContainer || !pvValue) {
                console.warn('âš ï¸ æœªæ‰¾åˆ°å¿…è¦çš„ DOM å…ƒç´ ');
                return;
            }

            // 4. æ¸…ç†æ—§çš„ ID (é‡è¦!)
            document.querySelectorAll('[id^="busuanzi_"]').forEach(el => {
                console.log('ğŸ—‘ï¸ ç§»é™¤æ—§ ID:', el.id);
                el.removeAttribute('id');
            });

            // 5. ç»‘å®šæ–°çš„ ID - å¿…é¡»åœ¨åŠ è½½è„šæœ¬ä¹‹å‰!
            pvContainer.id = 'busuanzi_container_page_pv';
            pvValue.id = 'busuanzi_value_page_pv';
            pvValue.textContent = '0'; // å…ˆæ˜¾ç¤º 0
            
            console.log('âœ… ID å·²ç»‘å®š:', pvContainer.id, pvValue.id);

            // 6. ç§»é™¤æ—§è„šæœ¬
            if (scriptElement && scriptElement.parentNode) {
                console.log('ğŸ—‘ï¸ ç§»é™¤æ—§çš„ Vercount è„šæœ¬');
                scriptElement.parentNode.removeChild(scriptElement);
                scriptElement = null;
            }
            
            // æ¸…é™¤å…¨å±€å¯¹è±¡
            if (window.busuanzi) {
                console.log('ğŸ—‘ï¸ æ¸…é™¤æ—§çš„ busuanzi å¯¹è±¡');
                delete window.busuanzi;
            }

            // 7. å»¶è¿ŸåŠ è½½è„šæœ¬,ç¡®ä¿ DOM å®Œå…¨å‡†å¤‡å¥½
            setTimeout(() => {
                console.log('ğŸ“¦ å¼€å§‹åŠ è½½ Vercount è„šæœ¬');
                
                scriptElement = document.createElement('script');
                scriptElement.src = "https://cn.vercount.one/js";
                scriptElement.async = true;
                scriptElement.defer = true; // æ·»åŠ  defer
                
                scriptElement.onload = function() {
                    console.log('âœ… Vercount è„šæœ¬åŠ è½½å®Œæˆ');
                    
                    // å¤šæ¬¡æ£€æŸ¥ busuanzi å¯¹è±¡
                    let checkCount = 0;
                    const checkInterval = setInterval(() => {
                        checkCount++;
                        console.log(`ğŸ” æ£€æŸ¥ busuanzi å¯¹è±¡ (${checkCount}/30)`);
                        
                        if (window.busuanzi && typeof window.busuanzi.fetch === 'function') {
                            clearInterval(checkInterval);
                            console.log('âœ… busuanzi å¯¹è±¡å·²åˆ›å»º,è°ƒç”¨ fetch()');
                            
                            // éªŒè¯ DOM å…ƒç´ è¿˜åœ¨
                            const checkPvValue = document.getElementById('busuanzi_value_page_pv');
                            if (checkPvValue) {
                                console.log('âœ… DOM å…ƒç´ éªŒè¯é€šè¿‡');
                                try {
                                    window.busuanzi.fetch();
                                    console.log('âœ… fetch() è°ƒç”¨æˆåŠŸ');
                                } catch(e) {
                                    console.error('âŒ fetch() è°ƒç”¨å¤±è´¥:', e);
                                }
                            } else {
                                console.error('âŒ DOM å…ƒç´ å·²ä¸¢å¤±!');
                            }
                        } else if (checkCount >= 30) {
                            // æ£€æŸ¥ 3 ç§’åæ”¾å¼ƒ
                            clearInterval(checkInterval);
                            console.error('âŒ busuanzi å¯¹è±¡åˆ›å»ºè¶…æ—¶');
                            
                            // æ£€æŸ¥è„šæœ¬æ˜¯å¦çœŸçš„åŠ è½½äº†
                            console.log('ğŸ” window.busuanzi:', window.busuanzi);
                            console.log('ğŸ” æ‰€æœ‰å…¨å±€å¯¹è±¡:', Object.keys(window).filter(k => k.includes('bus')));
                        }
                    }, 100);
                };
                
                scriptElement.onerror = function() {
                    console.error('âŒ Vercount è„šæœ¬åŠ è½½å¤±è´¥');
                    pvValue.textContent = 'N/A';
                };
                
                document.head.appendChild(scriptElement);
                console.log('ğŸ“¦ è„šæœ¬å·²æ·»åŠ åˆ° head');
                
            }, 200); // å»¶è¿Ÿ 200ms ç¡®ä¿ DOM ç¨³å®š
        }

        // æ¸…ç†å‡½æ•°
        function cleanup() {
            console.log('ğŸ§¹ PJAX è·³è½¬å¼€å§‹,æ¸…ç†æ•°æ®');
            document.querySelectorAll('.article-view').forEach(el => {
                el.style.display = 'none';
            });
        }

        // äº‹ä»¶ç›‘å¬
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initVercount);
        } else {
            initVercount();
        }
        
        document.addEventListener('pjax:send', cleanup);
        document.addEventListener('pjax:complete', () => {
            console.log('ğŸ”„ PJAX å®Œæˆ,é‡æ–°åˆå§‹åŒ–');
            initVercount();
        });
    })();
</script>